<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暴走古诗文坛</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<audio id="attack-sound" src="C:\Users\Administrator\Desktop\教学游戏\sounds\攻击2" preload="auto"></audio>
<audio id="hit-sound" src="C:\Users\Administrator\Desktop\教学游戏\sounds\攻击1.mp3" preload="auto"></audio>
<audio id="victory-sound" src="C:\Users\Administrator\Desktop\教学游戏\sounds\闯关成功.mp3" preload="auto"></audio>
<audio id="defeat-sound" src="C:\Users\Administrator\Desktop\教学游戏\sounds\闯关失败.mp3" preload="auto"></audio>
<audio id="button-click-sound" src="C:\Users\Administrator\Desktop\教学游戏\sounds\按键.mp3" preload="auto"></audio>
<audio id="mainMusic" src="C:\Users\Administrator\Desktop\教学游戏\sounds\沧海一声笑.mp3" preload="auto"></audio>
<audio id="battleMusic" src="C:\Users\Administrator\Desktop\教学游戏\sounds\男儿当自强.mp3" preload="auto"></audio>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B0000',
                        secondary: '#CD5C5C',
                        accent: '#FFD700',
                        bgPaper: '#F5F0DC',
                        enemy: '#8B4513',
                        player: '#4169E1'
                    },
                    fontFamily: {
                        martial: ['"Ma Shan Zheng"', 'cursive'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .pixel-border {
                box-shadow: 0 0 0 2px #000, 4px 4px 0 0 #000;
            }
            .character-shadow {
                filter: drop-shadow(3px 3px 0 #000);
            }
            .health-bar {
                height: 15px;
                position: relative;
                background: #333;
                border: 2px solid #000;
                border-radius: 4px;
                overflow: hidden;
            }
            .health-fill {
                height: 100%;
                transition: width 0.5s ease-in-out;
            }
            .health-label {
                position: absolute;
                top: -20px;
                font-size: 12px;
                font-weight: bold;
                color: #000;
            }
            .attack-animation {
                animation: attack 0.8s ease-in-out;
            }
            .hit-animation {
                animation: hit 0.5s ease-in-out;
            }
            .dodge-animation {
                animation: dodge 0.5s ease-in-out;
            }
            .miss-animation {
                animation: miss 0.5s ease-in-out;
            }
            .damage-text {
                position: absolute;
                animation: float-up 1s ease-out forwards;
                opacity: 0;
                font-weight: bold;
            }
            .float-in {
                animation: float-in 0.6s ease-out;
            }
            .btn-active {
                transform: translateY(2px);
                box-shadow: 0 0 0 2px #000, 2px 2px 0 0 #000;
            }
            .modal-backdrop {
                backdrop-filter: blur(4px);
            }
            @keyframes attack {
                0% { transform: translateX(0); }
                50% { transform: translateX(100px) scale(1.2); }
                100% { transform: translateX(0); }
            }
            @keyframes hit {
                0%, 100% { transform: rotate(0); }
                25% { transform: rotate(-5deg) translateX(-10px); }
                75% { transform: rotate(5deg) translateX(10px); }
            }
            @keyframes dodge {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(-30px); }
            }
            @keyframes miss {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(30px); }
            }
            @keyframes float-up {
                0% { transform: translateY(0); opacity: 1; }
                100% { transform: translateY(-30px); opacity: 0; }
            }
            @keyframes float-in {
                0% { transform: translateY(30px); opacity: 0; }
                100% { transform: translateY(0); opacity: 1; }
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            .pulse-animation {
                animation: pulse 1.5s infinite;
            }
        }
        .music-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 40;
        }
        .music-btn {
            background: rgba(139, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
</head>
<body class="bg-bgPaper min-h-screen font-martial overflow-x-hidden">
    <!-- 音频元素 -->
    <audio id="introMusic" loop>
        <source src="https://example.com/yie_ar_kung_fu_intro.mp3" type="audio/mpeg">
    </audio>
    <audio id="mainMusic" loop>
        <source src="https://example.com/canghai_yishengxiao.mp3" type="audio/mpeg">
    </audio>
    <audio id="battleMusic" loop>
        <source src="https://example.com/naner_dang_ziqiang.mp3" type="audio/mpeg">
    </audio>
    <audio id="attackSound">
        <source src="https://example.com/attack_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="hitSound">
        <source src="https://example.com/hit_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="dodgeSound">
        <source src="https://example.com/dodge_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="missSound">
        <source src="https://example.com/miss_sound.mp3" type="audio/mpeg">
    </audio>

    <!-- 加载指示器 -->
    <div id="loader" class="fixed inset-0 bg-bgPaper flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-xl">加载江湖秘籍中...</p>
        </div>
    </div>

    <div id="app" class="relative w-full max-w-5xl mx-auto px-2 py-4 hidden">
        <!-- 开始菜单 -->
        <div v-if="gameState === 'start'" class="float-in">
            <div class="text-center mt-12">
                <h1 class="text-[clamp(2.5rem,8vw,5rem)] font-bold text-primary drop-shadow-lg">暴走古诗文坛</h1>
                <p class="text-xl mt-4">——以文为剑，以诗为招——</p>
                
                <div class="mt-16 flex flex-col items-center gap-6">
                    <button 
                        class="bg-primary hover:bg-primary/80 text-white text-xl py-3 px-10 rounded-lg transition-all pixel-border"
                        @click="selectMode('single')"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        ref="startBtn"
                        aria-label="单人闯关模式"
                    >
                        <i class="fas fa-user mr-2"></i> 开始闯关
                    </button>
                    <button 
                        
                        class="bg-gray-600 hover:bg-gray-700 text-white text-lg py-2 px-8 rounded-lg transition-all"
                        @click="showHelp = true"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="查看帮助"
                    >
                        <i class="fas fa-book mr-2"></i> 江湖手册
                    </button>
                </div>
            </div>
        </div>

        <!-- 门派选择地图 -->
        <div v-else-if="gameState === 'map'" class="float-in">
            <div class="text-center mt-6 mb-8">
                <h2 class="text-3xl font-bold text-primary">选择门派挑战</h2>
                <p class="text-gray-600">击败门派长老，夺取武林秘籍！</p>
            </div>
            
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mt-10">
                <div 
                    v-for="(school, index) in schools" 
                    :key="school.id"
                    class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center shadow-md cursor-pointer transition-all transform hover:scale-105 pixel-border"
                    :class="!school.unlocked ? 'opacity-50 grayscale cursor-not-allowed' : ''"
                    @click="startBattle(school)"
                    @mousedown="isBtnActive = true"
                    @mouseup="isBtnActive = false"
                    @mouseleave="isBtnActive = false"
                    :class="isBtnActive ? 'btn-active' : ''"
                    :aria-disabled="!school.unlocked"
                >
                    <div class="relative mx-auto w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mb-3">
                        <i :class="'fas fa-' + school.icon + ' text-2xl text-primary'"></i>
                        <i v-if="school.completed" class="fas fa-check-circle absolute bottom-0 right-0 text-green-500"></i>
                    </div>
                    <h3 class="font-bold text-lg">{{ school.name }}</h3>
                    <p class="text-xs text-gray-500 mt-1">{{ school.master }}</p>
                </div>
            </div>
            
            <div class="absolute top-4 left-4">
                <button @click="backToStart" class="bg-gray-700/80 hover:bg-gray-700 text-white py-2 px-4 rounded-lg"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="返回主菜单">
                    <i class="fas fa-home mr-1"></i> 返回
                </button>
            </div>
        </div>

        <!-- 战斗界面 -->
        <div v-else-if="gameState === 'battle'" class="relative">
            <!-- 血条区域 -->
            <div class="flex justify-between items-center mb-8 mt-4 px-4">
                <!-- 玩家血条 -->
                <div class="w-1/4">
                    <div class="health-label left-0">侠客 (你)</div>
                    <div class="health-bar">
                        <div class="health-fill bg-player" :style="{ width: playerHealth + '%' }"></div>
                    </div>
                </div>
                
                <!-- 战斗标题 -->
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-primary">{{ currentSchool.name }}</h2>
                    <p class="text-sm text-gray-600">VS {{ currentSchool.master }}</p>
                </div>
                
                <!-- 敌人血条 -->
                <div class="w-1/4">
                    <div class="health-label right-0">{{ currentSchool.master }}</div>
                    <div class="health-bar">
                        <div class="health-fill bg-enemy" :style="{ width: enemyHealth + '%' }"></div>
                    </div>
                </div>
            </div>
            
            <!-- 角色区域 -->
            <div class="flex justify-between items-center px-8 my-12 relative">
                <div id="player-character" class="character-container">
                    <img 
                        :src="playerAvatar" 
                        alt="玩家角色" 
                        class="w-32 h-32 character-shadow"
                        :class="playerAnimation"
                    >
                </div>
                
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                    <p id="battle-log" class="text-center font-bold text-lg text-primary px-4 py-2 bg-white/70 rounded-lg shadow-md">{{ battleLog }}</p>
                </div>
                
                <div id="enemy-character" class="character-container">
                    <img 
                        :src="enemyAvatar" 
                        alt="敌人角色" 
                        class="w-32 h-32 character-shadow transform scale-x-[-1]"
                        :class="enemyAnimation"
                    >
                </div>
            </div>
            
            <!-- 题目区域 -->
            <div class="bg-white/90 rounded-xl p-6 shadow-xl pixel-border mx-4 mt-10">
                <div v-if="!showQuestion" class="text-center py-10">
                    <p class="text-lg text-gray-500">战斗开始！通过回答问题发动攻击！</p>
                    <button @click="showQuestion = true" class="mt-4 bg-primary hover:bg-primary/80 text-white py-2 px-6 rounded-lg"
                            @mousedown="isBtnActive = true"
                            @mouseup="isBtnActive = false"
                            @mouseleave="isBtnActive = false"
                            :class="isBtnActive ? 'btn-active' : ''"
                            aria-label="开始答题">
                        <i class="fas fa-book-open mr-1"></i> 开始答题
                    </button>
                </div>
                
                <div v-else class="space-y-6">
                    <div class="float-in">
                        <h3 class="text-xl font-bold text-primary mb-4">题目 {{ currentQuestionIndex + 1 }}/{{ totalQuestions }}</h3>
                        <p class="text-lg font-content">{{ currentQuestion.text }}</p>
                        <p v-if="currentQuestion.tip" class="text-sm text-blue-500 mt-2 italic">提示：{{ currentQuestion.tip }}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button 
                            v-for="(option, index) in currentQuestion.options" 
                            :key="index"
                            class="p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors text-left font-content"
                            @click="selectAnswer(option)"
                            :class="selectedAnswer === option ? 'border-primary bg-primary/10' : ''"
                            :disabled="isAnswering"
                            @mousedown="isBtnActive = true"
                            @mouseup="isBtnActive = false"
                            @mouseleave="isBtnActive = false"
                            :class="isBtnActive && !isAnswering ? 'btn-active' : ''"
                            :aria-disabled="isAnswering"
                        >
                            <span class="inline-block w-6 h-6 bg-gray-200 rounded-full text-center mr-2">
                                {{ ['A', 'B', 'C', 'D'][index] }}
                            </span>
                            {{ option }}
                        </button>
                    </div>
                    
                    <div v-if="answerFeedback" class="p-3 rounded-lg mt-2" :class="answerFeedback.correct ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                        <p>{{ answerFeedback.message }}</p>
                        <p v-if="!answerFeedback.correct" class="text-sm mt-1">正确答案：{{ currentQuestion.answer }}</p>
                    </div>
                </div>
            </div>
            
            <div class="absolute top-4 left-4">
                <button @click="backToMap" class="bg-gray-700/80 hover:bg-gray-700 text-white py-2 px-4 rounded-lg"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="返回地图">
                    <i class="fas fa-map mr-1"></i> 返回
                </button>
            </div>
        </div>

        <!-- 战斗结果 -->
        <div v-else-if="gameState === 'result'" class="text-center p-8 mt-10">
            <div class="inline-block bg-white/90 p-8 rounded-xl shadow-2xl pixel-border">
                <div v-if="battleWon" class="text-green-600">
                    <i class="fas fa-trophy text-6xl mb-4"></i>
                    <h2 class="text-3xl font-bold mb-2">战斗胜利！</h2>
                    <p class="text-lg">你击败了{{ currentSchool.master }}，获得了门派秘籍！</p>
                </div>
                <div v-else class="text-red-600">
                    <i class="fas fa-skull-crossbones text-6xl mb-4"></i>
                    <h2 class="text-3xl font-bold mb-2">战斗失败</h2>
                    <p class="text-lg">大侠请重新来过！</p>
                </div>
                
                <div class="mt-8 flex gap-4 justify-center">
                    <button @click="backToMap" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded-lg"
                            @mousedown="isBtnActive = true"
                            @mouseup="isBtnActive = false"
                            @mouseleave="isBtnActive = false"
                            :class="isBtnActive ? 'btn-active' : ''"
                            aria-label="返回地图">
                        <i class="fas fa-map mr-1"></i> 返回地图
                    </button>
                    <button 
                        @click="restartBattle()" 
                        class="bg-primary hover:bg-primary/80 text-white py-2 px-6 rounded-lg"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="重新挑战"
                    >
                        <i class="fas fa-redo mr-1"></i> {{ battleWon ? '挑战下一门派' : '重新挑战' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- 帮助弹窗 -->
        <div v-if="showHelp" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50" 
             @click.self="forceCloseHelp()" 
             v-on:keyup.esc="forceCloseHelp()" 
             tabindex="0" 
             role="dialog" 
             aria-modal="true">
            <div class="bg-white rounded-xl p-6 max-w-2xl max-h-[90vh] overflow-y-auto m-4 transform transition-transform float-in"
                 @click.stop>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-primary">江湖手册</h3>
                    <button @click="forceCloseHelp()" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition-colors"
                            aria-label="关闭帮助">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4 font-content">
                    <h4 class="text-xl font-bold text-accent mt-2">📜 基本规则</h4>
                    <p>选择门派挑战，通过回答古诗文问题击败门派长老。答对题目发动攻击，答错则会被攻击！</p>
                    
                    <h4 class="text-xl font-bold text-accent mt-4">⚔️ 战斗系统</h4>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>答对题目：发动攻击，敌人血条减少</li>
                        <li>答错题目：被敌人攻击，自己血条减少</li>
                        <li>连击奖励：连续答对3题触发大招，造成双倍伤害</li>
                        <li>闪避机制：玩家有10%几率闪避敌人攻击</li>
                    </ul>
                    
                    <h4 class="text-xl font-bold text-accent mt-4">🎵 音乐系统</h4>
                    <p>游戏包含完整的背景音乐和音效，增强战斗体验！</p>
                    
                    <button @click="forceCloseHelp()" class="mt-6 bg-primary hover:bg-primary/80 text-white py-2 px-6 rounded-lg pulse-animation"
                            aria-label="开始闯荡江湖">
                        <i class="fas fa-swords mr-1"></i> 开始闯荡江湖
                    </button>
                    
                    <!-- 紧急关闭按钮 -->
                    <div class="text-center mt-8 text-sm text-red-500">
                        <p>如果无法关闭此窗口，请点击下方紧急按钮</p>
                        <button @click="emergencyClose()" class="mt-2 text-red-600 underline hover:text-red-800"
                                aria-label="紧急关闭">
                            紧急关闭窗口
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 增加全局异常捕获，防止应用崩溃
        window.addEventListener('error', function(e) {
            console.error('全局错误捕获:', e.error);
            alert('发生错误，请刷新页面重试');
        });

        // 预加载所有资源后再显示页面
        document.addEventListener('DOMContentLoaded', function() {
            // 模拟资源加载
            setTimeout(() => {
                document.getElementById('loader').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                    
                    // 播放开场音乐
                    const introMusic = document.getElementById('introMusic');
                    try {
                        introMusic.volume = 0.6;
                        introMusic.play();
                    } catch (e) {
                        console.error('无法播放开场音乐:', e);
                    }
                }, 500);
            }, 800);
        });

        new Vue({
            el: '#app',
            data: {
                gameState: 'start', // start, map, battle, result
                gameMode: 'single', 
                showHelp: false,
                isBtnActive: false,
                isAnswering: false,
                schools: [
                    { id: 1, name: "三峡派", master: "郦长老", icon: "mountain", unlocked: true, completed: false },
                    { id: 2, name: "黄鹤楼派", master: "崔掌门", icon: "landmark", unlocked: false, completed: false },
                    { id: 3, name: "承天寺派", master: "苏居士", icon: "moon", unlocked: false, completed: false },
                    { id: 4, name: "野望派", master: "王隐士", icon: "tree", unlocked: false, completed: false },
                    { id: 5, name: "使至塞上派", master: "王摩诘", icon: "horse", unlocked: false, completed: false },
                    { id: 6, name: "钱塘湖派", master: "白乐天", icon: "water", unlocked: false, completed: false },
                ],
                currentSchool: null,
                playerHealth: 100,
                enemyHealth: 100,
                battleLog: "战斗准备就绪！",
                playerAnimation: "",
                enemyAnimation: "",
                showQuestion: false,
                questions: [],
                currentQuestionIndex: 0,
                currentQuestion: {},
                selectedAnswer: null,
                answerFeedback: null,
                battleWon: false,
                consecutiveCorrect: 0,
                // 使用本地base64图片替代外部图片
                playerAvatar: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMzgwIDI1NmgtMzJ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0aC0xMjBjLTU2IDAtOTYgNDAtOTYgOTZ2Mjg4YzAgNDggMzIgODAgODAgODBzNzUtMjQgNzUtNzZ2LTIwYzAtMzUuMy0yOC43LTY0LTY0LTY0ek0yMjQgMThjNjAgMCAxMDggNDggMTA4IDEwOFMyODQgMjM0IDIyNCAyMzRIMThDMTEuMyAyMzQgOCAyMzAgOCAyMjRWMTM0YzAgLTEzLjMgMy4zLTI0IDggMzJ2MTkyYzAgNDggMzIgODAgODAgODBoMTQ0YzMyIDAgNTYtMjQgNTYtNTZ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0ek0xODQgMjU2YzE2LjYgMCAzMC0xMy40IDMwLTMycy0xMy40LTMyLTMyLTMyLTMyIDEzLjQtMzAgMzJzMTMuNCAzMiAzMCAzMnoiLz48L3N2Zz4=",
                enemyAvatar: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjQkY3QjhCIiBkPSJNMzgwIDI1NmgtMzJ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0aC0xMjBjLTU2IDAtOTYgNDAtOTYgOTZ2Mjg4YzAgNDggMzIgODAgODAgODBzNzUtMjQgNzUtNzZ2LTIwYzAtMzUuMy0yOC43LTY0LTY0LTY0ek0yMjQgMThjNjAgMCAxMDggNDggMTA4IDEwOFMyODQgMjM0IDIyNCAyMzRIMThDMTEuMyAyMzQgOCAyMzAgOCAyMjRWMTM0YzAgLTEzLjMgMy4zLTI0IDggMzJ2MTkyYzAgNDggMzIgODAgODAgODBoMTQ0YzMyIDAgNTYtMjQgNTYtNTZ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0ek0xODQgMjU2YzE2LjYgMCAzMC0xMy40IDMwLTMycy0xMy40LTMyLTMyLTMyLTMyIDEzLjQtMzAgMzJzMTMuNCAzMiAzMCAzMnoiLz48L3N2Zz4="            
},
            computed: {
                totalQuestions() {
                    return this.questions.length;
                }
            },
            methods: {
               playMenuMusic() {
                    const bgm = document.getElementById('bgm-menu');
                    bgm.volume = 0.6;
                    bgm.play().catch(e => console.log("需要用户交互后才能播放音频"));
                },
                
                playBattleMusic() {
                    const bgmMenu = document.getElementById('bgm-menu');
                    const bgmBattle = document.getElementById('bgm-battle');
                    bgmMenu.pause();
                    bgmBattle.volume = 0.6;
                    bgmBattle.currentTime = 0;
                    bgmBattle.play();
                },
                // 音乐控制方法
                playSound(soundId) {
                    const sound = document.getElementById(soundId);
                    if (sound) {
                        sound.currentTime = 0;
                        sound.volume = 0.7;
                        sound.play().catch(e => console.error('无法播放音效:', e));
                    }
                },
                
                changeBackgroundMusic(newMusicId) {
                    // 停止所有背景音乐
                    const allMusic = ['introMusic', 'mainMusic', 'battleMusic'];
                    allMusic.forEach(id => {
                        const music = document.getElementById(id);
                        if (music) {
                            music.pause();
                            music.currentTime = 0;
                        }
                    });
                    
                    // 播放新音乐
                    if (newMusicId) {
                        const newMusic = document.getElementById(newMusicId);
                        if (newMusic) {
                            newMusic.volume = 0.5;
                            newMusic.play().catch(e => console.error('无法播放背景音乐:', e));
                        }
                    }
                },
                
                selectMode(mode) {
                    try {
                        this.gameMode = mode;
                        this.gameState = 'map';
                        // 切换到主界面音乐
                        this.changeBackgroundMusic('mainMusic');
                    } catch (e) {
                        console.error('选择模式错误:', e);
                        this.$data.gameMode = mode;
                        this.$data.gameState = 'map';
                    }
                },
                
                backToStart() {
                    this.gameState = 'start';
                    this.changeBackgroundMusic('introMusic');
                },
                
                backToMap() {
                    this.gameState = 'map';
                    this.changeBackgroundMusic('mainMusic');
                },
                
                startBattle(school) {
                    if (!school.unlocked) return;
                    
                    try {
                        this.currentSchool = school;
                        this.playerHealth = 100;
                        this.enemyHealth = 100;
                        this.battleLog = `挑战${school.name}${school.master}！`;
                        this.consecutiveCorrect = 0;
                        
                        // 加载当前门派的题目
                        this.loadQuestions(school.id);
                        
                        this.gameState = 'battle';
                        this.showQuestion = false;
                        this.currentQuestionIndex = 0;
                        this.currentQuestion = this.questions[0];
                        
                        // 切换到战斗音乐
                        this.changeBackgroundMusic('battleMusic');
                    } catch (e) {
                        console.error('开始战斗错误:', e);
                        alert('战斗加载失败，请重试');
                    }
                },
                
                loadQuestions(schoolId) {
                    if (schoolId === 1) {
                        this.questions = [
                            {
                                id: 1,
                                text: "'自三峡七百里中，两岸连山'的下一句是？",
                                options: [
                                    "略无阙处",
                                    "隐天蔽日",
                                    "自非亭午夜分",
                                    "不见曦月"
                                ],
                                answer: "略无阙处",
                                tip: "形容山势连绵不绝"
                            },
                            {
                                id: 2,
                                text: "'素湍绿潭，回清倒影'描写的是什么季节的景色？",
                                options: [
                                    "春季",
                                    "夏季",
                                    "秋季",
                                    "春冬之时"
                                ],
                                answer: "春冬之时"
                            },
                            {
                                id: 3,
                                text: "'虽乘奔御风，不以疾也'中的'奔'指的是？",
                                options: [
                                    "奔跑的人",
                                    "飞奔的马",
                                    "奔驰的船",
                                    "快速的风"
                                ],
                                answer: "飞奔的马"
                            }
                        ];
                    } else {
                        this.questions = [
                            {
                                id: 100,
                                text: "这是其他门派的题目示例",
                                options: ["选项1", "选项2", "选项3", "选项4"],
                                answer: "选项1",
                                tip: "示例提示"
                            }
                        ];
                    }
                },
                
                selectAnswer(option) {
                    if (this.isAnswering) return;
                    
                    this.isAnswering = true;
                    this.selectedAnswer = option;
                    const isCorrect = option === this.currentQuestion.answer;
                    
                    // 首先，无论对错，敌人都会攻击玩家
                    this.enemyAttack();
                    
                    if (isCorrect) {
                        this.consecutiveCorrect++;
                        this.answerFeedback = {
                            correct: true,
                            message: "回答正确！发动攻击！"
                        };
                        // 玩家攻击敌人
                        setTimeout(() => {
                            this.playerAttack();
                        }, 1500);
                    } else {
                        this.consecutiveCorrect = 0;
                        this.answerFeedback = {
                            correct: false,
                            message: "回答错误！攻击落空！"
                        };
                        // 玩家攻击但落空
                        setTimeout(() => {
                            this.playerMiss();
                        }, 1500);
                    }
                    
                    // 3秒后进入下一题
                    setTimeout(() => {
                        this.nextQuestion();
}, 3000);
                },
                
                nextQuestion() {
                    this.currentQuestionIndex++;
                    this.selectedAnswer = null;
                    this.answerFeedback = null;
                    this.isAnswering = false;
                    
                    if (this.currentQuestionIndex >= this.questions.length) {
                        this.battleWon = this.enemyHealth <= this.playerHealth;
                        this.currentSchool.completed = this.battleWon;
                        
                        if (this.battleWon && this.currentSchool.id < this.schools.length) {
                            const nextSchool = this.schools.find(s => s.id === this.currentSchool.id + 1);
                            if (nextSchool) nextSchool.unlocked = true;
                        }
                        
                        this.gameState = 'result';
if (this.battleWon) {
    document.getElementById('victory-sound').play();
} else {
    document.getElementById('defeat-sound').play();
}
                        this.changeBackgroundMusic('mainMusic');
                    } else {
                        this.currentQuestion = this.questions[this.currentQuestionIndex];
                    }
                },
                
                playerAttack() {
// 播放攻击音效
    document.getElementById('attack-sound').play();
                    this.playSound('attackSound');
                    
                    let damage = 15 + Math.floor(Math.random() * 5);
                    if (this.consecutiveCorrect >= 3) {
                        damage *= 2;
                        this.battleLog = "连击3次！发动大招！";
                    } else {
                        this.battleLog = "你默念心诀，使出师门秘传武功！";
                    }
                    
                    this.playerAnimation = "attack-animation";
                    setTimeout(() => {
                        this.playerAnimation = "";
                        this.enemyAnimation = "hit-animation";
                        
                        this.showDamageText('enemy', damage);
                        this.enemyHealth = Math.max(0, this.enemyHealth - damage);
                        
                        setTimeout(() => {
                            this.enemyAnimation = "";
                            
                            if (this.enemyHealth <= 0) {
                                this.battleWon = true;
                                this.currentSchool.completed = true;
                                if (this.currentSchool.id < this.schools.length) {
                                    const nextSchool = this.schools.find(s => s.id === this.currentSchool.id + 1);
                                    if (nextSchool) nextSchool.unlocked = true;
                                }
                                this.gameState = 'result';
                                this.changeBackgroundMusic('mainMusic');
                            }
                        }, 800);
                    }, 800);
                },
                
                playerMiss() {
                    this.playSound('missSound');
                    
                    this.battleLog = "你的攻击被对方轻松躲过！";
                    this.playerAnimation = "miss-animation";
                    
                    setTimeout(() => {
                        this.playerAnimation = "";
                    }, 800);
                },
                
                enemyAttack() {
    // 播放受击音效
    document.getElementById('hit-sound').play();

                    this.playSound('attackSound');
                    
                    this.battleLog = `${this.currentSchool.master}对你发动攻击！`;
                    
                    this.enemyAnimation = "attack-animation";
                    setTimeout(() => {
                        this.enemyAnimation = "";
                        
                        // 玩家有10%几率闪避
                        const dodgeChance = Math.random();
                        if (dodgeChance < 0.1) {
                            this.playSound('dodgeSound');
                            this.battleLog = "你身形一闪，躲过了攻击！";
                            this.playerAnimation = "dodge-animation";
                            
                            setTimeout(() => {
                                this.playerAnimation = "";
                            }, 800);
                        } else {
                            this.playSound('hitSound');
                            const damage = 10 + Math.floor(Math.random() * 5);
                            this.playerAnimation = "hit-animation";
                            
                            this.showDamageText('player', damage);
                            this.playerHealth = Math.max(0, this.playerHealth - damage);
                            
                            setTimeout(() => {
                                this.playerAnimation = "";
                                
                                if (this.playerHealth <= 0) {
                                    this.battleWon = false;
                                    this.gameState = 'result';
                                    this.changeBackgroundMusic('mainMusic');
                                }
                            }, 800);
                        }
                    }, 800);
                },
                
                showDamageText(target, damage) {
                    const element = document.getElementById(`${target}-character`);
                    const damageText = document.createElement('div');
                    damageText.className = 'damage-text';
                    damageText.textContent = `-${damage}`;
                    damageText.style.color = target === 'player' ? '#ff0000' : '#8B0000';
                    damageText.style.fontSize = '24px';
                    damageText.style.left = '50%';
                    damageText.style.top = '0';
                    
                    element.appendChild(damageText);
                    
                    setTimeout(() => {
                        element.removeChild(damageText);
                    }, 1000);
                },
                
                restartBattle() {
                    if (this.battleWon && this.currentSchool.id < this.schools.length) {
                        // 挑战下一门派
                        const nextSchool = this.schools.find(s => s.id === this.currentSchool.id + 1);
                        if (nextSchool) {
                            this.startBattle(nextSchool);
                            return;
                        }
                    }
                    // 重新挑战当前门派
                    this.startBattle(this.currentSchool);
                },
                
                forceCloseHelp() {
                    this.showHelp = false;
                },
                
                emergencyClose() {
                    this.showHelp = false;
                    alert('窗口已强制关闭');
                }
            }
        });
    </script>
</body>
</html>