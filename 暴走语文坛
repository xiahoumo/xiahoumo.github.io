<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš´èµ°å¤è¯—æ–‡å›</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<audio id="attack-sound" src="C:\Users\Administrator\Desktop\æ•™å­¦æ¸¸æˆ\sounds\æ”»å‡»2" preload="auto"></audio>
<audio id="hit-sound" src="C:\Users\Administrator\Desktop\æ•™å­¦æ¸¸æˆ\sounds\æ”»å‡»1.mp3" preload="auto"></audio>
<audio id="victory-sound" src="C:\Users\Administrator\Desktop\æ•™å­¦æ¸¸æˆ\sounds\é—¯å…³æˆåŠŸ.mp3" preload="auto"></audio>
<audio id="defeat-sound" src="C:\Users\Administrator\Desktop\æ•™å­¦æ¸¸æˆ\sounds\é—¯å…³å¤±è´¥.mp3" preload="auto"></audio>
<audio id="button-click-sound" src="C:\Users\Administrator\Desktop\æ•™å­¦æ¸¸æˆ\sounds\æŒ‰é”®.mp3" preload="auto"></audio>
<audio id="mainMusic" src="C:\Users\Administrator\Desktop\æ•™å­¦æ¸¸æˆ\sounds\æ²§æµ·ä¸€å£°ç¬‘.mp3" preload="auto"></audio>
<audio id="battleMusic" src="C:\Users\Administrator\Desktop\æ•™å­¦æ¸¸æˆ\sounds\ç”·å„¿å½“è‡ªå¼º.mp3" preload="auto"></audio>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B0000',
                        secondary: '#CD5C5C',
                        accent: '#FFD700',
                        bgPaper: '#F5F0DC',
                        enemy: '#8B4513',
                        player: '#4169E1'
                    },
                    fontFamily: {
                        martial: ['"Ma Shan Zheng"', 'cursive'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .pixel-border {
                box-shadow: 0 0 0 2px #000, 4px 4px 0 0 #000;
            }
            .character-shadow {
                filter: drop-shadow(3px 3px 0 #000);
            }
            .health-bar {
                height: 15px;
                position: relative;
                background: #333;
                border: 2px solid #000;
                border-radius: 4px;
                overflow: hidden;
            }
            .health-fill {
                height: 100%;
                transition: width 0.5s ease-in-out;
            }
            .health-label {
                position: absolute;
                top: -20px;
                font-size: 12px;
                font-weight: bold;
                color: #000;
            }
            .attack-animation {
                animation: attack 0.8s ease-in-out;
            }
            .hit-animation {
                animation: hit 0.5s ease-in-out;
            }
            .dodge-animation {
                animation: dodge 0.5s ease-in-out;
            }
            .miss-animation {
                animation: miss 0.5s ease-in-out;
            }
            .damage-text {
                position: absolute;
                animation: float-up 1s ease-out forwards;
                opacity: 0;
                font-weight: bold;
            }
            .float-in {
                animation: float-in 0.6s ease-out;
            }
            .btn-active {
                transform: translateY(2px);
                box-shadow: 0 0 0 2px #000, 2px 2px 0 0 #000;
            }
            .modal-backdrop {
                backdrop-filter: blur(4px);
            }
            @keyframes attack {
                0% { transform: translateX(0); }
                50% { transform: translateX(100px) scale(1.2); }
                100% { transform: translateX(0); }
            }
            @keyframes hit {
                0%, 100% { transform: rotate(0); }
                25% { transform: rotate(-5deg) translateX(-10px); }
                75% { transform: rotate(5deg) translateX(10px); }
            }
            @keyframes dodge {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(-30px); }
            }
            @keyframes miss {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(30px); }
            }
            @keyframes float-up {
                0% { transform: translateY(0); opacity: 1; }
                100% { transform: translateY(-30px); opacity: 0; }
            }
            @keyframes float-in {
                0% { transform: translateY(30px); opacity: 0; }
                100% { transform: translateY(0); opacity: 1; }
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            .pulse-animation {
                animation: pulse 1.5s infinite;
            }
        }
        .music-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 40;
        }
        .music-btn {
            background: rgba(139, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
</head>
<body class="bg-bgPaper min-h-screen font-martial overflow-x-hidden">
    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="introMusic" loop>
        <source src="https://example.com/yie_ar_kung_fu_intro.mp3" type="audio/mpeg">
    </audio>
    <audio id="mainMusic" loop>
        <source src="https://example.com/canghai_yishengxiao.mp3" type="audio/mpeg">
    </audio>
    <audio id="battleMusic" loop>
        <source src="https://example.com/naner_dang_ziqiang.mp3" type="audio/mpeg">
    </audio>
    <audio id="attackSound">
        <source src="https://example.com/attack_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="hitSound">
        <source src="https://example.com/hit_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="dodgeSound">
        <source src="https://example.com/dodge_sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="missSound">
        <source src="https://example.com/miss_sound.mp3" type="audio/mpeg">
    </audio>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loader" class="fixed inset-0 bg-bgPaper flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-xl">åŠ è½½æ±Ÿæ¹–ç§˜ç±ä¸­...</p>
        </div>
    </div>

    <div id="app" class="relative w-full max-w-5xl mx-auto px-2 py-4 hidden">
        <!-- å¼€å§‹èœå• -->
        <div v-if="gameState === 'start'" class="float-in">
            <div class="text-center mt-12">
                <h1 class="text-[clamp(2.5rem,8vw,5rem)] font-bold text-primary drop-shadow-lg">æš´èµ°å¤è¯—æ–‡å›</h1>
                <p class="text-xl mt-4">â€”â€”ä»¥æ–‡ä¸ºå‰‘ï¼Œä»¥è¯—ä¸ºæ‹›â€”â€”</p>
                
                <div class="mt-16 flex flex-col items-center gap-6">
                    <button 
                        class="bg-primary hover:bg-primary/80 text-white text-xl py-3 px-10 rounded-lg transition-all pixel-border"
                        @click="selectMode('single')"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        ref="startBtn"
                        aria-label="å•äººé—¯å…³æ¨¡å¼"
                    >
                        <i class="fas fa-user mr-2"></i> å¼€å§‹é—¯å…³
                    </button>
                    <button 
                        
                        class="bg-gray-600 hover:bg-gray-700 text-white text-lg py-2 px-8 rounded-lg transition-all"
                        @click="showHelp = true"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="æŸ¥çœ‹å¸®åŠ©"
                    >
                        <i class="fas fa-book mr-2"></i> æ±Ÿæ¹–æ‰‹å†Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- é—¨æ´¾é€‰æ‹©åœ°å›¾ -->
        <div v-else-if="gameState === 'map'" class="float-in">
            <div class="text-center mt-6 mb-8">
                <h2 class="text-3xl font-bold text-primary">é€‰æ‹©é—¨æ´¾æŒ‘æˆ˜</h2>
                <p class="text-gray-600">å‡»è´¥é—¨æ´¾é•¿è€ï¼Œå¤ºå–æ­¦æ—ç§˜ç±ï¼</p>
            </div>
            
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mt-10">
                <div 
                    v-for="(school, index) in schools" 
                    :key="school.id"
                    class="bg-white/80 backdrop-blur-sm rounded-lg p-4 text-center shadow-md cursor-pointer transition-all transform hover:scale-105 pixel-border"
                    :class="!school.unlocked ? 'opacity-50 grayscale cursor-not-allowed' : ''"
                    @click="startBattle(school)"
                    @mousedown="isBtnActive = true"
                    @mouseup="isBtnActive = false"
                    @mouseleave="isBtnActive = false"
                    :class="isBtnActive ? 'btn-active' : ''"
                    :aria-disabled="!school.unlocked"
                >
                    <div class="relative mx-auto w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mb-3">
                        <i :class="'fas fa-' + school.icon + ' text-2xl text-primary'"></i>
                        <i v-if="school.completed" class="fas fa-check-circle absolute bottom-0 right-0 text-green-500"></i>
                    </div>
                    <h3 class="font-bold text-lg">{{ school.name }}</h3>
                    <p class="text-xs text-gray-500 mt-1">{{ school.master }}</p>
                </div>
            </div>
            
            <div class="absolute top-4 left-4">
                <button @click="backToStart" class="bg-gray-700/80 hover:bg-gray-700 text-white py-2 px-4 rounded-lg"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="è¿”å›ä¸»èœå•">
                    <i class="fas fa-home mr-1"></i> è¿”å›
                </button>
            </div>
        </div>

        <!-- æˆ˜æ–—ç•Œé¢ -->
        <div v-else-if="gameState === 'battle'" class="relative">
            <!-- è¡€æ¡åŒºåŸŸ -->
            <div class="flex justify-between items-center mb-8 mt-4 px-4">
                <!-- ç©å®¶è¡€æ¡ -->
                <div class="w-1/4">
                    <div class="health-label left-0">ä¾ å®¢ (ä½ )</div>
                    <div class="health-bar">
                        <div class="health-fill bg-player" :style="{ width: playerHealth + '%' }"></div>
                    </div>
                </div>
                
                <!-- æˆ˜æ–—æ ‡é¢˜ -->
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-primary">{{ currentSchool.name }}</h2>
                    <p class="text-sm text-gray-600">VS {{ currentSchool.master }}</p>
                </div>
                
                <!-- æ•Œäººè¡€æ¡ -->
                <div class="w-1/4">
                    <div class="health-label right-0">{{ currentSchool.master }}</div>
                    <div class="health-bar">
                        <div class="health-fill bg-enemy" :style="{ width: enemyHealth + '%' }"></div>
                    </div>
                </div>
            </div>
            
            <!-- è§’è‰²åŒºåŸŸ -->
            <div class="flex justify-between items-center px-8 my-12 relative">
                <div id="player-character" class="character-container">
                    <img 
                        :src="playerAvatar" 
                        alt="ç©å®¶è§’è‰²" 
                        class="w-32 h-32 character-shadow"
                        :class="playerAnimation"
                    >
                </div>
                
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                    <p id="battle-log" class="text-center font-bold text-lg text-primary px-4 py-2 bg-white/70 rounded-lg shadow-md">{{ battleLog }}</p>
                </div>
                
                <div id="enemy-character" class="character-container">
                    <img 
                        :src="enemyAvatar" 
                        alt="æ•Œäººè§’è‰²" 
                        class="w-32 h-32 character-shadow transform scale-x-[-1]"
                        :class="enemyAnimation"
                    >
                </div>
            </div>
            
            <!-- é¢˜ç›®åŒºåŸŸ -->
            <div class="bg-white/90 rounded-xl p-6 shadow-xl pixel-border mx-4 mt-10">
                <div v-if="!showQuestion" class="text-center py-10">
                    <p class="text-lg text-gray-500">æˆ˜æ–—å¼€å§‹ï¼é€šè¿‡å›ç­”é—®é¢˜å‘åŠ¨æ”»å‡»ï¼</p>
                    <button @click="showQuestion = true" class="mt-4 bg-primary hover:bg-primary/80 text-white py-2 px-6 rounded-lg"
                            @mousedown="isBtnActive = true"
                            @mouseup="isBtnActive = false"
                            @mouseleave="isBtnActive = false"
                            :class="isBtnActive ? 'btn-active' : ''"
                            aria-label="å¼€å§‹ç­”é¢˜">
                        <i class="fas fa-book-open mr-1"></i> å¼€å§‹ç­”é¢˜
                    </button>
                </div>
                
                <div v-else class="space-y-6">
                    <div class="float-in">
                        <h3 class="text-xl font-bold text-primary mb-4">é¢˜ç›® {{ currentQuestionIndex + 1 }}/{{ totalQuestions }}</h3>
                        <p class="text-lg font-content">{{ currentQuestion.text }}</p>
                        <p v-if="currentQuestion.tip" class="text-sm text-blue-500 mt-2 italic">æç¤ºï¼š{{ currentQuestion.tip }}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button 
                            v-for="(option, index) in currentQuestion.options" 
                            :key="index"
                            class="p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors text-left font-content"
                            @click="selectAnswer(option)"
                            :class="selectedAnswer === option ? 'border-primary bg-primary/10' : ''"
                            :disabled="isAnswering"
                            @mousedown="isBtnActive = true"
                            @mouseup="isBtnActive = false"
                            @mouseleave="isBtnActive = false"
                            :class="isBtnActive && !isAnswering ? 'btn-active' : ''"
                            :aria-disabled="isAnswering"
                        >
                            <span class="inline-block w-6 h-6 bg-gray-200 rounded-full text-center mr-2">
                                {{ ['A', 'B', 'C', 'D'][index] }}
                            </span>
                            {{ option }}
                        </button>
                    </div>
                    
                    <div v-if="answerFeedback" class="p-3 rounded-lg mt-2" :class="answerFeedback.correct ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                        <p>{{ answerFeedback.message }}</p>
                        <p v-if="!answerFeedback.correct" class="text-sm mt-1">æ­£ç¡®ç­”æ¡ˆï¼š{{ currentQuestion.answer }}</p>
                    </div>
                </div>
            </div>
            
            <div class="absolute top-4 left-4">
                <button @click="backToMap" class="bg-gray-700/80 hover:bg-gray-700 text-white py-2 px-4 rounded-lg"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="è¿”å›åœ°å›¾">
                    <i class="fas fa-map mr-1"></i> è¿”å›
                </button>
            </div>
        </div>

        <!-- æˆ˜æ–—ç»“æœ -->
        <div v-else-if="gameState === 'result'" class="text-center p-8 mt-10">
            <div class="inline-block bg-white/90 p-8 rounded-xl shadow-2xl pixel-border">
                <div v-if="battleWon" class="text-green-600">
                    <i class="fas fa-trophy text-6xl mb-4"></i>
                    <h2 class="text-3xl font-bold mb-2">æˆ˜æ–—èƒœåˆ©ï¼</h2>
                    <p class="text-lg">ä½ å‡»è´¥äº†{{ currentSchool.master }}ï¼Œè·å¾—äº†é—¨æ´¾ç§˜ç±ï¼</p>
                </div>
                <div v-else class="text-red-600">
                    <i class="fas fa-skull-crossbones text-6xl mb-4"></i>
                    <h2 class="text-3xl font-bold mb-2">æˆ˜æ–—å¤±è´¥</h2>
                    <p class="text-lg">å¤§ä¾ è¯·é‡æ–°æ¥è¿‡ï¼</p>
                </div>
                
                <div class="mt-8 flex gap-4 justify-center">
                    <button @click="backToMap" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded-lg"
                            @mousedown="isBtnActive = true"
                            @mouseup="isBtnActive = false"
                            @mouseleave="isBtnActive = false"
                            :class="isBtnActive ? 'btn-active' : ''"
                            aria-label="è¿”å›åœ°å›¾">
                        <i class="fas fa-map mr-1"></i> è¿”å›åœ°å›¾
                    </button>
                    <button 
                        @click="restartBattle()" 
                        class="bg-primary hover:bg-primary/80 text-white py-2 px-6 rounded-lg"
                        @mousedown="isBtnActive = true"
                        @mouseup="isBtnActive = false"
                        @mouseleave="isBtnActive = false"
                        :class="isBtnActive ? 'btn-active' : ''"
                        aria-label="é‡æ–°æŒ‘æˆ˜"
                    >
                        <i class="fas fa-redo mr-1"></i> {{ battleWon ? 'æŒ‘æˆ˜ä¸‹ä¸€é—¨æ´¾' : 'é‡æ–°æŒ‘æˆ˜' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- å¸®åŠ©å¼¹çª— -->
        <div v-if="showHelp" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50" 
             @click.self="forceCloseHelp()" 
             v-on:keyup.esc="forceCloseHelp()" 
             tabindex="0" 
             role="dialog" 
             aria-modal="true">
            <div class="bg-white rounded-xl p-6 max-w-2xl max-h-[90vh] overflow-y-auto m-4 transform transition-transform float-in"
                 @click.stop>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-primary">æ±Ÿæ¹–æ‰‹å†Œ</h3>
                    <button @click="forceCloseHelp()" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition-colors"
                            aria-label="å…³é—­å¸®åŠ©">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4 font-content">
                    <h4 class="text-xl font-bold text-accent mt-2">ğŸ“œ åŸºæœ¬è§„åˆ™</h4>
                    <p>é€‰æ‹©é—¨æ´¾æŒ‘æˆ˜ï¼Œé€šè¿‡å›ç­”å¤è¯—æ–‡é—®é¢˜å‡»è´¥é—¨æ´¾é•¿è€ã€‚ç­”å¯¹é¢˜ç›®å‘åŠ¨æ”»å‡»ï¼Œç­”é”™åˆ™ä¼šè¢«æ”»å‡»ï¼</p>
                    
                    <h4 class="text-xl font-bold text-accent mt-4">âš”ï¸ æˆ˜æ–—ç³»ç»Ÿ</h4>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>ç­”å¯¹é¢˜ç›®ï¼šå‘åŠ¨æ”»å‡»ï¼Œæ•Œäººè¡€æ¡å‡å°‘</li>
                        <li>ç­”é”™é¢˜ç›®ï¼šè¢«æ•Œäººæ”»å‡»ï¼Œè‡ªå·±è¡€æ¡å‡å°‘</li>
                        <li>è¿å‡»å¥–åŠ±ï¼šè¿ç»­ç­”å¯¹3é¢˜è§¦å‘å¤§æ‹›ï¼Œé€ æˆåŒå€ä¼¤å®³</li>
                        <li>é—ªé¿æœºåˆ¶ï¼šç©å®¶æœ‰10%å‡ ç‡é—ªé¿æ•Œäººæ”»å‡»</li>
                    </ul>
                    
                    <h4 class="text-xl font-bold text-accent mt-4">ğŸµ éŸ³ä¹ç³»ç»Ÿ</h4>
                    <p>æ¸¸æˆåŒ…å«å®Œæ•´çš„èƒŒæ™¯éŸ³ä¹å’ŒéŸ³æ•ˆï¼Œå¢å¼ºæˆ˜æ–—ä½“éªŒï¼</p>
                    
                    <button @click="forceCloseHelp()" class="mt-6 bg-primary hover:bg-primary/80 text-white py-2 px-6 rounded-lg pulse-animation"
                            aria-label="å¼€å§‹é—¯è¡æ±Ÿæ¹–">
                        <i class="fas fa-swords mr-1"></i> å¼€å§‹é—¯è¡æ±Ÿæ¹–
                    </button>
                    
                    <!-- ç´§æ€¥å…³é—­æŒ‰é’® -->
                    <div class="text-center mt-8 text-sm text-red-500">
                        <p>å¦‚æœæ— æ³•å…³é—­æ­¤çª—å£ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹ç´§æ€¥æŒ‰é’®</p>
                        <button @click="emergencyClose()" class="mt-2 text-red-600 underline hover:text-red-800"
                                aria-label="ç´§æ€¥å…³é—­">
                            ç´§æ€¥å…³é—­çª—å£
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¢åŠ å…¨å±€å¼‚å¸¸æ•è·ï¼Œé˜²æ­¢åº”ç”¨å´©æºƒ
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯æ•è·:', e.error);
            alert('å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        });

        // é¢„åŠ è½½æ‰€æœ‰èµ„æºåå†æ˜¾ç¤ºé¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // æ¨¡æ‹Ÿèµ„æºåŠ è½½
            setTimeout(() => {
                document.getElementById('loader').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                    
                    // æ’­æ”¾å¼€åœºéŸ³ä¹
                    const introMusic = document.getElementById('introMusic');
                    try {
                        introMusic.volume = 0.6;
                        introMusic.play();
                    } catch (e) {
                        console.error('æ— æ³•æ’­æ”¾å¼€åœºéŸ³ä¹:', e);
                    }
                }, 500);
            }, 800);
        });

        new Vue({
            el: '#app',
            data: {
                gameState: 'start', // start, map, battle, result
                gameMode: 'single', 
                showHelp: false,
                isBtnActive: false,
                isAnswering: false,
                schools: [
                    { id: 1, name: "ä¸‰å³¡æ´¾", master: "éƒ¦é•¿è€", icon: "mountain", unlocked: true, completed: false },
                    { id: 2, name: "é»„é¹¤æ¥¼æ´¾", master: "å´”æŒé—¨", icon: "landmark", unlocked: false, completed: false },
                    { id: 3, name: "æ‰¿å¤©å¯ºæ´¾", master: "è‹å±…å£«", icon: "moon", unlocked: false, completed: false },
                    { id: 4, name: "é‡æœ›æ´¾", master: "ç‹éšå£«", icon: "tree", unlocked: false, completed: false },
                    { id: 5, name: "ä½¿è‡³å¡ä¸Šæ´¾", master: "ç‹æ‘©è¯˜", icon: "horse", unlocked: false, completed: false },
                    { id: 6, name: "é’±å¡˜æ¹–æ´¾", master: "ç™½ä¹å¤©", icon: "water", unlocked: false, completed: false },
                ],
                currentSchool: null,
                playerHealth: 100,
                enemyHealth: 100,
                battleLog: "æˆ˜æ–—å‡†å¤‡å°±ç»ªï¼",
                playerAnimation: "",
                enemyAnimation: "",
                showQuestion: false,
                questions: [],
                currentQuestionIndex: 0,
                currentQuestion: {},
                selectedAnswer: null,
                answerFeedback: null,
                battleWon: false,
                consecutiveCorrect: 0,
                // ä½¿ç”¨æœ¬åœ°base64å›¾ç‰‡æ›¿ä»£å¤–éƒ¨å›¾ç‰‡
                playerAvatar: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMzgwIDI1NmgtMzJ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0aC0xMjBjLTU2IDAtOTYgNDAtOTYgOTZ2Mjg4YzAgNDggMzIgODAgODAgODBzNzUtMjQgNzUtNzZ2LTIwYzAtMzUuMy0yOC43LTY0LTY0LTY0ek0yMjQgMThjNjAgMCAxMDggNDggMTA4IDEwOFMyODQgMjM0IDIyNCAyMzRIMThDMTEuMyAyMzQgOCAyMzAgOCAyMjRWMTM0YzAgLTEzLjMgMy4zLTI0IDggMzJ2MTkyYzAgNDggMzIgODAgODAgODBoMTQ0YzMyIDAgNTYtMjQgNTYtNTZ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0ek0xODQgMjU2YzE2LjYgMCAzMC0xMy40IDMwLTMycy0xMy40LTMyLTMyLTMyLTMyIDEzLjQtMzAgMzJzMTMuNCAzMiAzMCAzMnoiLz48L3N2Zz4=",
                enemyAvatar: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjQkY3QjhCIiBkPSJNMzgwIDI1NmgtMzJ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0aC0xMjBjLTU2IDAtOTYgNDAtOTYgOTZ2Mjg4YzAgNDggMzIgODAgODAgODBzNzUtMjQgNzUtNzZ2LTIwYzAtMzUuMy0yOC43LTY0LTY0LTY0ek0yMjQgMThjNjAgMCAxMDggNDggMTA4IDEwOFMyODQgMjM0IDIyNCAyMzRIMThDMTEuMyAyMzQgOCAyMzAgOCAyMjRWMTM0YzAgLTEzLjMgMy4zLTI0IDggMzJ2MTkyYzAgNDggMzIgODAgODAgODBoMTQ0YzMyIDAgNTYtMjQgNTYtNTZ2LTY0YzAtMzUuMy0yOC43LTY0LTY0LTY0ek0xODQgMjU2YzE2LjYgMCAzMC0xMy40IDMwLTMycy0xMy40LTMyLTMyLTMyLTMyIDEzLjQtMzAgMzJzMTMuNCAzMiAzMCAzMnoiLz48L3N2Zz4="            
},
            computed: {
                totalQuestions() {
                    return this.questions.length;
                }
            },
            methods: {
               playMenuMusic() {
                    const bgm = document.getElementById('bgm-menu');
                    bgm.volume = 0.6;
                    bgm.play().catch(e => console.log("éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾éŸ³é¢‘"));
                },
                
                playBattleMusic() {
                    const bgmMenu = document.getElementById('bgm-menu');
                    const bgmBattle = document.getElementById('bgm-battle');
                    bgmMenu.pause();
                    bgmBattle.volume = 0.6;
                    bgmBattle.currentTime = 0;
                    bgmBattle.play();
                },
                // éŸ³ä¹æ§åˆ¶æ–¹æ³•
                playSound(soundId) {
                    const sound = document.getElementById(soundId);
                    if (sound) {
                        sound.currentTime = 0;
                        sound.volume = 0.7;
                        sound.play().catch(e => console.error('æ— æ³•æ’­æ”¾éŸ³æ•ˆ:', e));
                    }
                },
                
                changeBackgroundMusic(newMusicId) {
                    // åœæ­¢æ‰€æœ‰èƒŒæ™¯éŸ³ä¹
                    const allMusic = ['introMusic', 'mainMusic', 'battleMusic'];
                    allMusic.forEach(id => {
                        const music = document.getElementById(id);
                        if (music) {
                            music.pause();
                            music.currentTime = 0;
                        }
                    });
                    
                    // æ’­æ”¾æ–°éŸ³ä¹
                    if (newMusicId) {
                        const newMusic = document.getElementById(newMusicId);
                        if (newMusic) {
                            newMusic.volume = 0.5;
                            newMusic.play().catch(e => console.error('æ— æ³•æ’­æ”¾èƒŒæ™¯éŸ³ä¹:', e));
                        }
                    }
                },
                
                selectMode(mode) {
                    try {
                        this.gameMode = mode;
                        this.gameState = 'map';
                        // åˆ‡æ¢åˆ°ä¸»ç•Œé¢éŸ³ä¹
                        this.changeBackgroundMusic('mainMusic');
                    } catch (e) {
                        console.error('é€‰æ‹©æ¨¡å¼é”™è¯¯:', e);
                        this.$data.gameMode = mode;
                        this.$data.gameState = 'map';
                    }
                },
                
                backToStart() {
                    this.gameState = 'start';
                    this.changeBackgroundMusic('introMusic');
                },
                
                backToMap() {
                    this.gameState = 'map';
                    this.changeBackgroundMusic('mainMusic');
                },
                
                startBattle(school) {
                    if (!school.unlocked) return;
                    
                    try {
                        this.currentSchool = school;
                        this.playerHealth = 100;
                        this.enemyHealth = 100;
                        this.battleLog = `æŒ‘æˆ˜${school.name}${school.master}ï¼`;
                        this.consecutiveCorrect = 0;
                        
                        // åŠ è½½å½“å‰é—¨æ´¾çš„é¢˜ç›®
                        this.loadQuestions(school.id);
                        
                        this.gameState = 'battle';
                        this.showQuestion = false;
                        this.currentQuestionIndex = 0;
                        this.currentQuestion = this.questions[0];
                        
                        // åˆ‡æ¢åˆ°æˆ˜æ–—éŸ³ä¹
                        this.changeBackgroundMusic('battleMusic');
                    } catch (e) {
                        console.error('å¼€å§‹æˆ˜æ–—é”™è¯¯:', e);
                        alert('æˆ˜æ–—åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                },
                
                loadQuestions(schoolId) {
                    if (schoolId === 1) {
                        this.questions = [
                            {
                                id: 1,
                                text: "'è‡ªä¸‰å³¡ä¸ƒç™¾é‡Œä¸­ï¼Œä¸¤å²¸è¿å±±'çš„ä¸‹ä¸€å¥æ˜¯ï¼Ÿ",
                                options: [
                                    "ç•¥æ— é˜™å¤„",
                                    "éšå¤©è”½æ—¥",
                                    "è‡ªéäº­åˆå¤œåˆ†",
                                    "ä¸è§æ›¦æœˆ"
                                ],
                                answer: "ç•¥æ— é˜™å¤„",
                                tip: "å½¢å®¹å±±åŠ¿è¿ç»µä¸ç»"
                            },
                            {
                                id: 2,
                                text: "'ç´ æ¹ç»¿æ½­ï¼Œå›æ¸…å€’å½±'æå†™çš„æ˜¯ä»€ä¹ˆå­£èŠ‚çš„æ™¯è‰²ï¼Ÿ",
                                options: [
                                    "æ˜¥å­£",
                                    "å¤å­£",
                                    "ç§‹å­£",
                                    "æ˜¥å†¬ä¹‹æ—¶"
                                ],
                                answer: "æ˜¥å†¬ä¹‹æ—¶"
                            },
                            {
                                id: 3,
                                text: "'è™½ä¹˜å¥”å¾¡é£ï¼Œä¸ä»¥ç–¾ä¹Ÿ'ä¸­çš„'å¥”'æŒ‡çš„æ˜¯ï¼Ÿ",
                                options: [
                                    "å¥”è·‘çš„äºº",
                                    "é£å¥”çš„é©¬",
                                    "å¥”é©°çš„èˆ¹",
                                    "å¿«é€Ÿçš„é£"
                                ],
                                answer: "é£å¥”çš„é©¬"
                            }
                        ];
                    } else {
                        this.questions = [
                            {
                                id: 100,
                                text: "è¿™æ˜¯å…¶ä»–é—¨æ´¾çš„é¢˜ç›®ç¤ºä¾‹",
                                options: ["é€‰é¡¹1", "é€‰é¡¹2", "é€‰é¡¹3", "é€‰é¡¹4"],
                                answer: "é€‰é¡¹1",
                                tip: "ç¤ºä¾‹æç¤º"
                            }
                        ];
                    }
                },
                
                selectAnswer(option) {
                    if (this.isAnswering) return;
                    
                    this.isAnswering = true;
                    this.selectedAnswer = option;
                    const isCorrect = option === this.currentQuestion.answer;
                    
                    // é¦–å…ˆï¼Œæ— è®ºå¯¹é”™ï¼Œæ•Œäººéƒ½ä¼šæ”»å‡»ç©å®¶
                    this.enemyAttack();
                    
                    if (isCorrect) {
                        this.consecutiveCorrect++;
                        this.answerFeedback = {
                            correct: true,
                            message: "å›ç­”æ­£ç¡®ï¼å‘åŠ¨æ”»å‡»ï¼"
                        };
                        // ç©å®¶æ”»å‡»æ•Œäºº
                        setTimeout(() => {
                            this.playerAttack();
                        }, 1500);
                    } else {
                        this.consecutiveCorrect = 0;
                        this.answerFeedback = {
                            correct: false,
                            message: "å›ç­”é”™è¯¯ï¼æ”»å‡»è½ç©ºï¼"
                        };
                        // ç©å®¶æ”»å‡»ä½†è½ç©º
                        setTimeout(() => {
                            this.playerMiss();
                        }, 1500);
                    }
                    
                    // 3ç§’åè¿›å…¥ä¸‹ä¸€é¢˜
                    setTimeout(() => {
                        this.nextQuestion();
}, 3000);
                },
                
                nextQuestion() {
                    this.currentQuestionIndex++;
                    this.selectedAnswer = null;
                    this.answerFeedback = null;
                    this.isAnswering = false;
                    
                    if (this.currentQuestionIndex >= this.questions.length) {
                        this.battleWon = this.enemyHealth <= this.playerHealth;
                        this.currentSchool.completed = this.battleWon;
                        
                        if (this.battleWon && this.currentSchool.id < this.schools.length) {
                            const nextSchool = this.schools.find(s => s.id === this.currentSchool.id + 1);
                            if (nextSchool) nextSchool.unlocked = true;
                        }
                        
                        this.gameState = 'result';
if (this.battleWon) {
    document.getElementById('victory-sound').play();
} else {
    document.getElementById('defeat-sound').play();
}
                        this.changeBackgroundMusic('mainMusic');
                    } else {
                        this.currentQuestion = this.questions[this.currentQuestionIndex];
                    }
                },
                
                playerAttack() {
// æ’­æ”¾æ”»å‡»éŸ³æ•ˆ
    document.getElementById('attack-sound').play();
                    this.playSound('attackSound');
                    
                    let damage = 15 + Math.floor(Math.random() * 5);
                    if (this.consecutiveCorrect >= 3) {
                        damage *= 2;
                        this.battleLog = "è¿å‡»3æ¬¡ï¼å‘åŠ¨å¤§æ‹›ï¼";
                    } else {
                        this.battleLog = "ä½ é»˜å¿µå¿ƒè¯€ï¼Œä½¿å‡ºå¸ˆé—¨ç§˜ä¼ æ­¦åŠŸï¼";
                    }
                    
                    this.playerAnimation = "attack-animation";
                    setTimeout(() => {
                        this.playerAnimation = "";
                        this.enemyAnimation = "hit-animation";
                        
                        this.showDamageText('enemy', damage);
                        this.enemyHealth = Math.max(0, this.enemyHealth - damage);
                        
                        setTimeout(() => {
                            this.enemyAnimation = "";
                            
                            if (this.enemyHealth <= 0) {
                                this.battleWon = true;
                                this.currentSchool.completed = true;
                                if (this.currentSchool.id < this.schools.length) {
                                    const nextSchool = this.schools.find(s => s.id === this.currentSchool.id + 1);
                                    if (nextSchool) nextSchool.unlocked = true;
                                }
                                this.gameState = 'result';
                                this.changeBackgroundMusic('mainMusic');
                            }
                        }, 800);
                    }, 800);
                },
                
                playerMiss() {
                    this.playSound('missSound');
                    
                    this.battleLog = "ä½ çš„æ”»å‡»è¢«å¯¹æ–¹è½»æ¾èº²è¿‡ï¼";
                    this.playerAnimation = "miss-animation";
                    
                    setTimeout(() => {
                        this.playerAnimation = "";
                    }, 800);
                },
                
                enemyAttack() {
    // æ’­æ”¾å—å‡»éŸ³æ•ˆ
    document.getElementById('hit-sound').play();

                    this.playSound('attackSound');
                    
                    this.battleLog = `${this.currentSchool.master}å¯¹ä½ å‘åŠ¨æ”»å‡»ï¼`;
                    
                    this.enemyAnimation = "attack-animation";
                    setTimeout(() => {
                        this.enemyAnimation = "";
                        
                        // ç©å®¶æœ‰10%å‡ ç‡é—ªé¿
                        const dodgeChance = Math.random();
                        if (dodgeChance < 0.1) {
                            this.playSound('dodgeSound');
                            this.battleLog = "ä½ èº«å½¢ä¸€é—ªï¼Œèº²è¿‡äº†æ”»å‡»ï¼";
                            this.playerAnimation = "dodge-animation";
                            
                            setTimeout(() => {
                                this.playerAnimation = "";
                            }, 800);
                        } else {
                            this.playSound('hitSound');
                            const damage = 10 + Math.floor(Math.random() * 5);
                            this.playerAnimation = "hit-animation";
                            
                            this.showDamageText('player', damage);
                            this.playerHealth = Math.max(0, this.playerHealth - damage);
                            
                            setTimeout(() => {
                                this.playerAnimation = "";
                                
                                if (this.playerHealth <= 0) {
                                    this.battleWon = false;
                                    this.gameState = 'result';
                                    this.changeBackgroundMusic('mainMusic');
                                }
                            }, 800);
                        }
                    }, 800);
                },
                
                showDamageText(target, damage) {
                    const element = document.getElementById(`${target}-character`);
                    const damageText = document.createElement('div');
                    damageText.className = 'damage-text';
                    damageText.textContent = `-${damage}`;
                    damageText.style.color = target === 'player' ? '#ff0000' : '#8B0000';
                    damageText.style.fontSize = '24px';
                    damageText.style.left = '50%';
                    damageText.style.top = '0';
                    
                    element.appendChild(damageText);
                    
                    setTimeout(() => {
                        element.removeChild(damageText);
                    }, 1000);
                },
                
                restartBattle() {
                    if (this.battleWon && this.currentSchool.id < this.schools.length) {
                        // æŒ‘æˆ˜ä¸‹ä¸€é—¨æ´¾
                        const nextSchool = this.schools.find(s => s.id === this.currentSchool.id + 1);
                        if (nextSchool) {
                            this.startBattle(nextSchool);
                            return;
                        }
                    }
                    // é‡æ–°æŒ‘æˆ˜å½“å‰é—¨æ´¾
                    this.startBattle(this.currentSchool);
                },
                
                forceCloseHelp() {
                    this.showHelp = false;
                },
                
                emergencyClose() {
                    this.showHelp = false;
                    alert('çª—å£å·²å¼ºåˆ¶å…³é—­');
                }
            }
        });
    </script>
</body>
</html>
